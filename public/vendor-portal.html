<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOUCHED | Vendor Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: { extend: { colors: { marble: '#fafaf9', 'marble-dark': '#f5f5f4', charcoal: '#1a1a1a', slate: '#404040', gold: '#b8a369' } } }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .serif { font-family: 'Cormorant Garamond', serif; }
        .marble-bg { background: radial-gradient(ellipse at 30% 20%, rgba(0,0,0,0.02) 0%, transparent 50%), linear-gradient(180deg, #fafaf9 0%, #f5f5f4 100%); }
        .gold-btn { background: linear-gradient(135deg, #b8a369, #c4b896); transition: all 0.3s; }
        .gold-btn:hover { transform: translateY(-1px); box-shadow: 0 10px 30px rgba(184, 163, 105, 0.2); }
        .product-card { transition: all 0.3s ease; cursor: pointer; background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); }
        .product-card:hover { box-shadow: 0 0 40px rgba(255,255,255,0.6), 0 10px 40px rgba(0,0,0,0.08); transform: translateY(-2px); }
        input:focus, select:focus { border-color: rgba(184, 163, 105, 0.5) !important; outline: none; }
        .sidebar { transition: width 0.3s ease; background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .nav-text, .sidebar.collapsed .nav-section-title, .sidebar.collapsed .user-details { display: none; }
        .sidebar-brand { font-family: 'Cormorant Garamond', serif; border: 2px solid #b8a369; padding: 0.375rem 0.75rem; border-radius: 0.5rem; display: inline-flex; align-items: center; justify-content: center; }
        .sidebar.collapsed .sidebar-brand { font-size: 0; padding: 0; width: 40px; height: 40px; border: 2px solid #b8a369; }
        .sidebar.collapsed .sidebar-brand::before { content: 'V'; font-size: 1.3rem; display: flex; align-items: center; justify-content: center; }
        .nav-item { transition: all 0.2s; }
        .nav-item:hover { background: rgba(184, 163, 105, 0.1); }
        .nav-item.active { background: rgba(184, 163, 105, 0.1); border-right: 2px solid #b8a369; }
        .view-btn { transition: all 0.2s; }
        .view-btn.active { background: rgba(184, 163, 105, 0.15); color: #b8a369; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #fafaf9; }
        ::-webkit-scrollbar-thumb { background: rgba(26,26,26,0.15); }
            /* Dark Mode */
        .dark { background: #0a0a0a !important; }
        .dark .marble-bg { background: #0a0a0a !important; }
        .dark .sidebar { background: rgba(15,15,15,0.98) !important; border-right-color: #b8a369 !important; }
        .dark .product-card { background: rgba(30,30,30,0.9) !important; border-color: rgba(184,163,105,0.2) !important; }
        .dark .text-charcoal, .dark h1, .dark h2, .dark h3, .dark p { color: #f0f0f0 !important; }
        .dark .text-slate { color: #888 !important; }
        .dark .bg-white, .dark .bg-marble { background: #1a1a1a !important; }
        .dark input, .dark select { background: #1a1a1a !important; border-color: #333 !important; color: #f0f0f0 !important; }
        .dark-toggle { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 999; width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #b8a369, #c4b896); color: #0a0a0a; font-size: 20px; cursor: pointer; border: none; box-shadow: 0 4px 20px rgba(184,163,105,0.4); transition: transform 0.2s; }
        .dark-toggle:hover { transform: scale(1.1); }
    </style>
</head>
<body class="marble-bg text-charcoal h-screen flex overflow-hidden">
    <!-- B2B Professional Gate -->
    <div id="proGate" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[9999]" style="display:none;">
        <div class="bg-white rounded-2xl p-12 max-w-lg text-center shadow-2xl">
            <h2 class="serif text-4xl font-bold text-charcoal mb-6">Licensed Professionals Only</h2>
            <p class="text-slate mb-8">This platform is exclusively for New York State OCM-licensed cannabis businesses.<br>No retail dispensaries ‚Ä¢ Wholesale only</p>
            <button onclick="localStorage.setItem('proVerified','true');document.getElementById('proGate').remove()" class="px-10 py-4 gold-btn text-white font-bold rounded-lg hover:scale-105 transition">I am a Licensed Professional</button>
        </div>
    </div>
    <script>if (!localStorage.getItem('proVerified')) document.getElementById('proGate').style.display = 'flex';</script>
    
    <aside id="sidebar" class="sidebar w-64 h-full border-r border-black/5 flex flex-col z-40">
        <div class="p-5 border-b border-black/5 flex items-center justify-between">
            <a href="index.html"><h1 class="serif text-xl font-semibold tracking-[0.12em] text-charcoal sidebar-brand">VOUCHED</h1></a>
            <button id="toggleSidebar" class="w-7 h-7 rounded bg-black/5 hover:bg-black/10 flex items-center justify-center">
                <svg class="w-3 h-3 text-slate" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/></svg>
            </button>
        </div>
        <div class="p-4 border-b border-black/5">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-gold/30 to-gold/10 flex items-center justify-center text-gold text-sm font-medium" id="userAvatar">?</div>
                <div class="user-details flex-1 min-w-0">
                    <p id="sidebarUserName" class="font-medium text-charcoal text-sm truncate">Loading...</p>
                    <p id="sidebarUserRole" class="text-[10px] text-gold uppercase tracking-wider">Member</p>
                </div>
            </div>
        </div>
        <nav class="flex-1 py-4 overflow-y-auto">
            <div class="px-4 mb-2"><p class="nav-section-title text-[10px] text-slate/50 uppercase tracking-[0.15em]">Browse</p></div>
            <a href="traditions-bulk.html" class="nav-item flex items-center gap-3 px-4 py-3 text-slate hover:text-charcoal"><span class="text-sm">‚óá</span><span class="nav-text text-sm">MARKETPLACE</span></a>
            <a href="broker-dashboard.html" class="nav-item flex items-center gap-3 px-4 py-3 text-slate hover:text-charcoal"><span class="text-sm">‚óà</span><span class="nav-text text-sm">PORTAL</span></a>
            <div class="px-4 mt-6 mb-2"><p class="nav-section-title text-[10px] text-slate/50 uppercase tracking-[0.15em]">System</p></div>
            <a href="admin-dashboard.html" class="nav-item flex items-center gap-3 px-4 py-3 text-slate hover:text-charcoal"><span class="text-sm">‚öô</span><span class="nav-text text-sm">Admin</span></a>
        </nav>
        <div class="p-4 border-t border-black/5">
            <button id="signOutBtn" class="nav-item w-full flex items-center gap-3 px-3 py-2 text-slate/50 hover:text-slate rounded"><span class="text-sm">‚Üí</span><span class="nav-text text-sm">Sign Out</span></button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto relative z-10">
        <div class="max-w-7xl mx-auto px-8 py-8">
            <!-- Vendor Header -->
            <div class="mb-12">
                <a href="traditions-bulk.html" class="inline-flex items-center gap-2 text-slate hover:text-charcoal text-sm mb-4">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    Back to Marketplace
                </a>
                <div class="flex items-center gap-6 mb-6">
                    <div class="w-24 h-24 rounded-lg bg-gradient-to-br from-gold/30 to-gold/10 flex items-center justify-center text-gold text-3xl font-semibold" id="vendorAvatar">?</div>
                    <div>
                        <h1 class="serif text-4xl font-semibold text-charcoal mb-2" id="vendorName">Loading...</h1>
                        <p class="text-slate mb-4" id="vendorEmail">-</p>
                        <div class="flex items-center gap-8">
                            <div><p class="text-[10px] text-slate/50 uppercase tracking-wider">Products</p><p class="text-2xl font-semibold text-charcoal" id="productCount">0</p></div>
                            <div><p class="text-[10px] text-slate/50 uppercase tracking-wider">Quality</p><p class="text-lg font-medium text-gold" id="vendorQuality">Verified</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters & View -->
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                <div class="flex items-center gap-3 bg-white/70 rounded-lg border border-black/5 p-1">
                    <button id="viewGrid" class="view-btn active w-8 h-8 rounded flex items-center justify-center text-slate">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                    </button>
                    <button id="viewList" class="view-btn w-8 h-8 rounded flex items-center justify-center text-slate">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/></svg>
                    </button>
                </div>
                <div class="flex items-center gap-3">
                    <select id="sortBy" class="bg-white/70 border border-black/10 rounded-lg px-4 py-2 text-slate text-sm">
                        <option value="newest">Newest</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="thc-high">THC: High to Low</option>
                    </select>
                </div>
            </div>

            <!-- Products Grid -->
            <div id="productGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                <p class="text-slate col-span-full text-center py-12">Loading products...</p>
            </div>
        </div>
    </main>

    <!-- Product Detail Modal -->
    <div id="productModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-2xl shadow-2xl overflow-hidden"><div id="modalContent"></div></div>
    </div>

    <script type="module">
        import { auth, db } from './js/firebase-init.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { collection, query, where, onSnapshot, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        let currentUser = null, vendorId = null, allProducts = [], filteredProducts = [], currentView = 'grid';

        // Get vendor ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        vendorId = urlParams.get('id');

        if (!vendorId) {
            window.location.href = 'traditions-bulk.html';
        }

        document.getElementById('toggleSidebar').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('collapsed');
            localStorage.setItem('sidebarCollapsed', document.getElementById('sidebar').classList.contains('collapsed'));
        });
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            document.getElementById('sidebar').classList.add('collapsed');
        }

        document.getElementById('viewGrid').addEventListener('click', () => setView('grid'));
        document.getElementById('viewList').addEventListener('click', () => setView('list'));

        function setView(view) {
            currentView = view;
            document.getElementById('viewGrid').classList.toggle('active', view === 'grid');
            document.getElementById('viewList').classList.toggle('active', view === 'list');
            renderProducts();
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = 'login.html'; return; }
            currentUser = user;
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                const name = userData.companyName || userData.firstName || 'User';
                document.getElementById('sidebarUserName').textContent = name;
                document.getElementById('sidebarUserRole').textContent = userData.role || 'Member';
                document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
            }
            loadVendor();
            loadProducts();
        });

        document.getElementById('signOutBtn').addEventListener('click', () => signOut(auth));

        async function loadVendor() {
            const vendorDoc = await getDoc(doc(db, 'users', vendorId));
            if (vendorDoc.exists()) {
                const vendor = vendorDoc.data();
                document.getElementById('vendorName').textContent = vendor.companyName || vendor.firstName || 'Vendor';
                document.getElementById('vendorEmail').textContent = vendor.email || '-';
                document.getElementById('vendorAvatar').textContent = (vendor.firstName || vendor.email || '?').charAt(0).toUpperCase();
            }
        }

        function loadProducts() {
            const q = query(collection(db, 'inventory'), where('userId', '==', vendorId), where('isPublic', '==', true));
            onSnapshot(q, (snap) => {
                allProducts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('productCount').textContent = allProducts.length;
                applyFilters();
            });
        }

        document.getElementById('sortBy').addEventListener('change', applyFilters);

        function applyFilters() {
            const sortBy = document.getElementById('sortBy').value;
            filteredProducts = [...allProducts];
            filteredProducts.sort((a, b) => {
                switch (sortBy) {
                    case 'price-low': return (a.price || 0) - (b.price || 0);
                    case 'price-high': return (b.price || 0) - (a.price || 0);
                    case 'thc-high': return (b.thc || 0) - (a.thc || 0);
                    default: return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                }
            });
            renderProducts();
        }

        function renderProducts() {
            const grid = document.getElementById('productGrid');
            if (!filteredProducts.length) {
                grid.innerHTML = '<p class="text-slate col-span-full text-center py-12">No public products</p>';
                return;
            }
            if (currentView === 'grid') {
                grid.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4';
                grid.innerHTML = filteredProducts.map(p => `
                    <div class="product-card rounded-lg border border-black/5 overflow-hidden" data-id="${p.id}">
                        <div class="relative aspect-square bg-marble-dark">
                            ${p.videoUrls?.[0] ? `<video src="${p.videoUrls[0]}" class="w-full h-full object-cover" autoplay muted loop playsinline></video>` : p.imageUrls?.[0] ? `<img src="${p.imageUrls[0]}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-slate/50 text-sm">No Media</div>'}
                            <div class="absolute inset-0 bg-gradient-to-t from-white/90 via-transparent to-transparent"></div>
                            <span class="absolute top-2 left-2 px-2 py-0.5 text-[9px] uppercase tracking-wider rounded bg-gold/20 text-gold">${(p.quality || 'INDOOR').replace('_', ' ')}</span>
                            <div class="absolute bottom-0 left-0 right-0 p-3"><h3 class="font-medium text-charcoal text-sm truncate">${p.name}</h3><p class="text-lg font-semibold text-gold">$${p.price}</p></div>
                        </div>
                    </div>`).join('');
            } else {
                grid.className = 'flex flex-col gap-3';
                grid.innerHTML = filteredProducts.map(p => `
                    <div class="product-card rounded-lg border border-black/5 overflow-hidden flex" data-id="${p.id}">
                        <div class="w-32 h-24 bg-marble-dark flex-shrink-0">${p.videoUrls?.[0] ? `<video src="${p.videoUrls[0]}" class="w-full h-full object-cover" autoplay muted loop playsinline></video>` : p.imageUrls?.[0] ? `<img src="${p.imageUrls[0]}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-slate/50 text-xs">No Media</div>'}</div>
                        <div class="flex-1 p-4 flex items-center justify-between">
                            <div><h3 class="font-medium text-charcoal">${p.name}</h3></div>
                            <div class="flex items-center gap-6">
                                <span class="px-2 py-0.5 text-[9px] uppercase tracking-wider rounded bg-gold/15 text-gold">${(p.quality || 'INDOOR').replace('_', ' ')}</span>
                                <div class="text-right"><p class="text-[10px] text-slate/50 uppercase">THC</p><p class="text-charcoal font-medium">${p.thc || 0}%</p></div>
                                <div class="text-right"><p class="text-[10px] text-slate/50 uppercase">Stock</p><p class="text-charcoal font-medium">${p.stock || 0}</p></div>
                                <div class="text-right"><p class="text-2xl font-semibold text-gold">$${p.price}</p></div>
                            </div>
                        </div>
                    </div>`).join('');
            }
            grid.querySelectorAll('.product-card').forEach(card => card.addEventListener('click', () => openProductModal(filteredProducts.find(p => p.id === card.dataset.id))));
        }

        function openProductModal(product) {
            const modal = document.getElementById('productModal');
            modal.classList.remove('hidden');
            document.getElementById('modalContent').innerHTML = `
                <div class="flex flex-col lg:flex-row">
                    <div class="lg:w-1/2 aspect-square lg:aspect-auto bg-marble-dark rounded-l-xl overflow-hidden relative">
                        ${product.videoUrls?.[0] ? `<video src="${product.videoUrls[0]}" class="w-full h-full object-contain" autoplay loop muted controls></video>` : product.imageUrls?.[0] ? `<img src="${product.imageUrls[0]}" class="w-full h-full object-contain">` : '<div class="w-full h-full flex items-center justify-center text-slate/50">No Media</div>'}
                        <button class="close-modal absolute top-4 right-4 w-8 h-8 bg-white/80 rounded-full flex items-center justify-center text-slate hover:text-charcoal">√ó</button>
                    </div>
                    <div class="lg:w-1/2 p-8 flex flex-col">
                        <h2 class="serif text-2xl text-charcoal mb-4">${product.name}</h2>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-marble p-4 rounded-lg border border-black/5"><p class="text-[10px] text-slate/50 uppercase mb-1">Price</p><p class="text-2xl font-semibold text-gold">$${product.price}</p></div>
                            <div class="bg-marble p-4 rounded-lg border border-black/5"><p class="text-[10px] text-slate/50 uppercase mb-1">THC</p><p class="text-2xl font-semibold text-charcoal">${product.thc || 0}%</p></div>
                            <div class="bg-marble p-4 rounded-lg border border-black/5"><p class="text-[10px] text-slate/50 uppercase mb-1">Stock</p><p class="text-2xl font-semibold text-gold">${product.stock || 0}</p></div>
                            <div class="bg-marble p-4 rounded-lg border border-black/5"><p class="text-[10px] text-slate/50 uppercase mb-1">Quality</p><p class="text-sm font-medium text-charcoal">${(product.quality || '').replace('_', ' ')}</p></div>
                        </div>
                        ${product.labUrl ? `<a href="${product.labUrl}" target="_blank" class="flex items-center gap-3 p-4 bg-gold/10 border border-gold/20 rounded-lg mb-6 hover:bg-gold/20 transition"><span class="text-gold">üìã</span><span class="text-charcoal font-medium">View COA</span></a>` : ''}
                        <div class="mt-auto space-y-3">
                            <p class="text-[10px] text-slate/50 uppercase tracking-wider mb-2">Contact Vendor</p>
                            <div class="flex flex-col gap-2">
                                <a href="https://wa.me/${product.vendorPhone || ''}?text=Hi,%20I%20am%20interested%20in%20${encodeURIComponent(product.name)}" target="_blank" class="flex items-center justify-center gap-2 px-4 py-2 bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-600 rounded-lg text-sm font-medium transition">
                                    <span>üí¨</span> WhatsApp
                                </a>
                                <a href="https://signal.me/#p/${product.vendorPhone || ''}" target="_blank" class="flex items-center justify-center gap-2 px-4 py-2 bg-blue-500/20 hover:bg-blue-500/30 text-blue-600 rounded-lg text-sm font-medium transition">
                                    <span>üîê</span> Signal
                                </a>
                                <a href="mailto:${product.vendorEmail}?subject=Inquiry%20about%20${encodeURIComponent(product.name)}&body=Hi,%20I%20am%20interested%20in%20your%20${encodeURIComponent(product.name)}%20listing." class="flex items-center justify-center gap-2 px-4 py-2 gold-btn text-white rounded-lg text-sm font-medium">
                                    <span>üìß</span> Email
                                </a>
                            </div>
                        </div>
                    </div>
                </div>`;
            modal.querySelector('.close-modal').addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });
        }
    </script>
    <!-- Dark Mode Toggle -->
    <button id="darkToggle" class="dark-toggle" onclick="document.body.classList.toggle('dark'); localStorage.setItem('darkMode', document.body.classList.contains('dark'))">??</button>
    <script>
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark');
            document.getElementById('darkToggle').textContent = '??';
        }
        document.getElementById('darkToggle').addEventListener('click', function() {
            this.textContent = document.body.classList.contains('dark') ? '??' : '??';
        });
    </script>
</body>
</html>
